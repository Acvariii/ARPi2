# ARPi2 - Augmented Reality Board Game System

A gesture-controlled board game system using computer vision for hand tracking. Features Monopoly, Blackjack, and D&D with support for up to 8 players using hand gestures captured by a Raspberry Pi camera.

## Features

- **Hand Tracking**: Real-time hand detection and finger tracking using MediaPipe
- **Gesture Control**: Hover-based interactions - hold your finger over buttons to activate them
- **Mouse Support**: Fallback mouse control for testing and development
- **Multi-player Support**: Up to 8 players can play simultaneously
- **Multiple Games**: Monopoly, Blackjack, and Dungeons & Dragons
- **Thin Client Architecture**: Server handles processing, Pi displays rendered frames
- **High Performance**: 50-60 FPS on Raspberry Pi with server-side rendering

## System Requirements

### Server PC (runs game logic and hand tracking)
- Python 3.8+
- OpenCV (`opencv-python`)
- MediaPipe
- Pygame
- Websockets
- NumPy
- Recommended: Dedicated GPU for better performance

### Raspberry Pi (thin client - camera + display)
- Raspberry Pi 3/4/5 with camera module or USB webcam
- Python 3.8+
- OpenCV (`opencv-python`)
- Pygame
- Websockets
- NumPy

## Installation

### On Server PC (Windows/Linux/Mac)

```bash
# Clone the repository
git clone <repository-url>
cd ARPi2

# Install dependencies
pip install opencv-python mediapipe pygame websockets numpy
```

### On Raspberry Pi

```bash
# Clone the repository
git clone <repository-url>
cd ARPi2

# Install dependencies
pip install opencv-python pygame websockets numpy

# Enable camera interface (if using Pi Camera Module)
sudo raspi-config
# Navigate to: Interface Options -> Camera -> Enable
```

## Configuration

Before running, update the IP address in `config.py` to match your server PC's IP:

```python
SERVER_WS = "ws://YOUR_SERVER_IP:5000"
```

**Note**: Replace `YOUR_SERVER_IP` with your server's actual IP address (e.g., `192.168.1.79`)

To find your server's IP address:
- **Windows**: `ipconfig` in Command Prompt
- **Linux/Mac**: `ifconfig` or `ip addr` in Terminal

The server listens on port **8765** for thin client connections.

## Usage

### Running the System

#### Method 1: Thin Client Mode (Recommended - Maximum Performance)

**On Server PC:**
```bash
# Start the game server with hand tracking
python game_server_full.py
```

**On Raspberry Pi:**
```bash
# Start the thin client (camera + display only)
python pi_thin_client.py
```

This mode provides the best performance:
- **Server**: Handles all game logic, rendering, and hand tracking
- **Raspberry Pi**: Only captures camera and displays frames (~60 FPS)

#### Method 2: Legacy Mode (Original Architecture)

**On Server PC:**
```bash
# Start the server with video display
python main.py server
```

**On Raspberry Pi:**
```bash
# Start the camera client
python main.py pi
```

**On Another Device (optional - for the game interface):**
```bash
# Start the game launcher
python main.py launcher
```

#### Method 3: Standalone Mode (Testing)

```bash
# Run game locally with mouse control
python launcher.py
```

### Game Controls

The game supports two input methods:

#### Hand Tracking (Primary Method)
1. **Point your index finger** at any button or interactive element
2. **Hold it steady** for ~1 second to activate
3. A **circular progress indicator** appears showing activation progress

#### Mouse Control (Testing/Fallback)
- **Move mouse** to position cursor
- **Hover over elements** for 1 second to activate
- Same circular progress indicator appears
- Works on both server and thin client

#### Keyboard
- **ESC**: Exit application immediately
- **Text input**: Supported in D&D character creation

### Available Games

#### Monopoly
1. **Select game**: Hover over "Monopoly" button in main menu
2. **Select Players**: 
   - Hover over player slots around the board edges to toggle selection
   - Selected slots will be highlighted in the player's color
   - Minimum 2 players required to start
3. **Start Game**: Hover over the "Start" button (enabled when 2+ players selected)

#### In-Game Controls

Each player panel has three buttons:

- **Roll/End Turn** (Current player only):
  - Shows "Roll" when you can roll dice
  - Shows "End Turn" after rolling (unless you rolled doubles)
  
- **Props** (Properties):
  - View your owned properties
  - Navigate with Prev/Next buttons
  - Shows money and Get Out of Jail cards
  
- **Mortgage**:
  - Manage property mortgages (feature in development)

#### Gameplay

1. **Current player** is highlighted with a gold border
2. **Hover over "Roll"** to roll dice
   - Dice will shake and show result
   - Your token moves automatically
3. **Buying Property**:
   - When you land on an unowned property, a prompt appears
   - Hover "Yes" to buy or "No" to decline
4. **Special Spaces**:
   - **Go**: Collect $200
   - **Jail**: Just visiting (unless sent there)
   - **Free Parking**: Rest space
   - **Go to Jail**: Sent directly to jail
   - **Chance/Community Chest**: Draw cards (feature in development)

#### Rolling Doubles

- If you roll doubles (same number on both dice), you can roll again
- Rolling 3 doubles in a row sends you to jail

#### Blackjack
1. **Select game**: Hover over "Blackjack" button in main menu
2. **Select Players**: Choose 2-8 players
3. **Gameplay**:
   - All players act simultaneously (free-for-all mode)
   - **Ready**: Join the current round
   - **Hit**: Request another card
   - **Stand**: Keep current hand
   - Each player has independent betting and balance
   - Dealer plays automatically after all players stand

#### Dungeons & Dragons
1. **Select game**: Hover over "D&D" button in main menu
2. **Character Creation** (full-screen immersive experience):
   - **Choose Race**: Human, Elf, Dwarf, Halfling, Orc, or Tiefling
   - **Choose Class**: Fighter, Wizard, Rogue, Cleric, Ranger, or Paladin
   - **Set Abilities**: Distribute 27 points across STR, DEX, CON, INT, WIS, CHA
   - Character names are automatically generated based on race/class
3. **Save/Load**: Characters are saved and can be loaded in future sessions
4. **DM Mode**: Right player (position 7) is always the Dungeon Master
5. **Gameplay**:
   - View character sheets
   - Roll d20 with automatic crit highlighting
   - Turn-based character actions

## Video Display

When the server runs with `python main.py server`, a video window automatically opens showing:

- **Live camera feed** from the Raspberry Pi
- **Colored circles** around detected fingertips
- **Hand labels** (Left/Right with hand ID)
- **Hand count** in the top-left corner

**Keyboard shortcuts** in video window:
- Press `Q` to close the video window
- Press `ESC` to exit the game

## Project Structure

```
ARPi2/
├── game_server_full.py     # NEW: Thin client server (game + hand tracking)
├── pi_thin_client.py       # NEW: Thin client for Raspberry Pi
├── game_server.py          # Alternative: Lightweight server
├── main.py                 # Entry point with mode selection (legacy)
├── launcher.py             # Game launcher application
├── config.py               # Configuration (IP, ports, constants)
├── server.py               # WebSocket server + hand tracking processor
├── pi_client.py            # Raspberry Pi camera client (legacy)
├── hand_tracking.py        # Hand tracking client module
├── video_display.py        # Video feed display with overlays
├── ui_components.py        # Reusable UI components
├── player_panel.py         # Player panel positioning and rendering
├── monopoly/               # Monopoly game module
│   ├── game.py            # Main game logic
│   ├── player.py          # Player management
│   ├── property.py        # Property cards and spaces
│   ├── drawing.py         # Rendering utilities
│   ├── popups.py          # UI popups (buy, trade, etc.)
│   └── game_logic.py      # Core game mechanics
├── blackjack/              # Blackjack game module (structure similar to monopoly)
├── dnd/                    # D&D game module
│   ├── game.py            # Main D&D game logic
│   ├── character.py       # Character creation and management
│   ├── game_logic.py      # Dice rolling, combat, skills
│   ├── drawing.py         # Character sheets, dice visualizer
│   └── creation_visuals.py # Immersive character creation UI
└── dnd_saves/              # D&D character save files (JSON)
```

## Network Architecture

### Thin Client Mode (Recommended)

```
┌──────────────────────────┐
│   Raspberry Pi           │
│   (Thin Client)          │
│                          │
│  1. Camera Capture       │──── Camera Feed ────▶
│  2. Display Frames       │◀─── Game Frames ─────┐
│  3. Send Mouse/Keyboard  │──── Input Events ────▶│
│                          │                        │
│  pi_thin_client.py       │                        │
└──────────────────────────┘                        │
                                                    │
                                    ┌───────────────▼────────────┐
                                    │   Server PC                │
                                    │   (Does Everything)        │
                                    │                            │
                                    │  1. Hand Tracking          │
                                    │  2. Game Logic             │
                                    │  3. Rendering              │
                                    │  4. Frame Compression      │
                                    │                            │
                                    │  game_server_full.py       │
                                    └────────────────────────────┘
```

### Legacy Mode (Original)

```
┌─────────────────┐         ┌─────────────────┐
│  Raspberry Pi   │         │   Server PC     │
│  (Camera)       │──────▶│  (Processing)   │
│                 │ frames  │                 │
│  pi_client.py   │         │  server.py      │
└─────────────────┘         │  video_display  │
                            └────────┬────────┘
                                     │ hand data
                                     ▼
                            ┌─────────────────┐
                            │  Game Client    │
                            │  (UI)           │
                            │  launcher.py    │
                            └─────────────────┘
```

## Troubleshooting

### Camera not connecting
- Check IP address configuration in `config.py`
- Ensure both devices are on the same network
- Check firewall settings (port 8765 should be open)
- Test connection: `ping YOUR_SERVER_IP`

### Thin client not connecting
- Ensure server is running first (`game_server_full.py`)
- Check server IP in `pi_thin_client.py` connection URL
- Look for "Connected to game server!" message
- Server shows "Client connected" when Pi connects

### Hand tracking not working
- Ensure good lighting conditions
- Keep hands within camera view
- Camera should have clear view of gesture area
- Try adjusting `min_detection_confidence` in `game_server_full.py`
- Check server console for "Hands tracked: X" messages

### Game not responding to gestures
- Hold finger steady for full 1 second
- Ensure you're pointing with index finger
- Watch for circular progress indicator
- Mouse can be used for testing on both server and client
- Press **ESC** to exit if needed

### Performance issues (Thin Client Mode)
- Should achieve 50-60 FPS on Pi by default
- Lower camera resolution in `pi_thin_client.py` if needed:
  - Change `cv2.VideoCapture(0)` settings
  - Reduce `frame_small` resize dimensions
- Adjust JPEG quality (lower = better performance, worse quality):
  - Server: `IMWRITE_JPEG_QUALITY` in `game_server_full.py`
  - Client: `IMWRITE_JPEG_QUALITY` in `pi_thin_client.py`

### Performance issues (Legacy Mode)
- Lower camera resolution in `pi_client.py` (WIDTH/HEIGHT)
- Reduce JPEG_QUALITY in `pi_client.py`
- Decrease FPS in `pi_client.py`
- Close video display if not needed

### Application won't exit
- Press **ESC** key (works on both server and client)
- Use **Ctrl+C** in terminal as backup
- Force quit if necessary

## Camera Setup

For optimal hand tracking:

1. **Position**: Mount camera overhead, angled down at ~45° toward the table
2. **Height**: 2-3 feet above the play surface
3. **Lighting**: Ensure even, bright lighting (avoid shadows)
4. **Background**: Use a plain, contrasting surface
5. **Coverage**: Camera should see the entire play area

## Development

### Adding New Games

1. Create a new game class similar to `MonopolyGame` in `monopoly.py`
2. Add game button in `launcher.py` (`_create_game_buttons`)
3. Handle game initialization in `launcher.py` (`handle_menu_state`)

### Customizing Hand Tracking

Edit `server.py`:
```python
hands_detector = mp_hands.Hands(
    max_num_hands=8,              # Maximum hands to detect
    min_detection_confidence=0.5,  # Lower = more sensitive
    min_tracking_confidence=0.5    # Lower = more tracking noise
)
```

### Adjusting Hover Time

Edit `HOVER_TIME_THRESHOLD` in:
- `launcher.py` (line 14)
- `ui_elements.py` (line 5)
- `ui_components.py` (line 4)

Default is 0.9 seconds. Lower values = faster activation.

## Performance Comparison

| Mode | Pi FPS | Game Logic | Hand Tracking | Latency |
|------|--------|------------|---------------|---------|
| **Thin Client** | **50-60** | Server | Server | ~16-50ms |
| Legacy Mode | 15-25 | Client | Server | ~30-100ms |
| Standalone | 30-45 | Local | Local | 0ms |

**Recommended**: Use thin client mode for best Pi performance.

## Known Limitations

- Only index finger is tracked for interactions
- Maximum 8 players supported
- Network latency depends on WiFi quality (LAN cable recommended)
- Monopoly features in development:
  - Trading between players
  - Auction system
  - Full Chance/Community Chest implementation
  - House/Hotel building
- D&D features in development:
  - Full combat system
  - Inventory management
  - Quest/campaign tracking
  - NPC interactions

## License

[Add your license here]

## Contributing

[Add contribution guidelines here]

## Credits

- Hand tracking: MediaPipe by Google
- Game framework: Pygame
- Networking: Websockets