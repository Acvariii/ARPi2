# ARPi2 - Augmented Reality Board Game System

A gesture-controlled board game system using computer vision for hand tracking. Features a complete Monopoly implementation, Blackjack, and D&D with support for up to 8 players using hand gestures captured by a Raspberry Pi camera.

## Features

- **Hand Tracking**: Real-time hand detection and finger tracking using MediaPipe
- **Gesture Control**: Hover-based interactions - hold your finger over buttons to activate them
- **Mouse Support**: Fallback mouse control for testing and development
- **Multi-player Support**: Up to 8 players can play simultaneously
- **Multiple Games**: Complete Monopoly with all rules, Blackjack, and Dungeons & Dragons
- **High Performance**: OpenGL-accelerated rendering with Pyglet
- **Complete Monopoly**: Full implementation with houses/hotels, trading, auctions, mortgages, and all card actions

## System Requirements

### Server PC (runs game logic and hand tracking)
- Python 3.8+
- OpenCV (`opencv-python`)
- MediaPipe
- Pyglet (OpenGL acceleration)
- Websockets
- NumPy
- Recommended: Dedicated GPU (NVIDIA/AMD) for optimal performance
  - Configure Windows Graphics Settings to use high-performance GPU
  - See troubleshooting section for GPU configuration

### Raspberry Pi (thin client - camera + display)
- Raspberry Pi 3/4/5 with camera module or USB webcam
- Python 3.8+
- OpenCV (`opencv-python`)
- Pygame
- Websockets
- NumPy

## Installation

### On Server PC (Windows/Linux/Mac)

```bash
# Clone the repository
git clone <repository-url>
cd ARPi2

# Install dependencies
pip install opencv-python mediapipe pyglet websockets numpy
```

### On Raspberry Pi

```bash
# Clone the repository
git clone <repository-url>
cd ARPi2

# Install dependencies
pip install opencv-python pyglet websockets numpy

# Enable camera interface (if using Pi Camera Module)
sudo raspi-config
# Navigate to: Interface Options -> Camera -> Enable
```

## Configuration

Before running, update the IP address in `config.py` to match your server PC's IP:

```python
SERVER_WS = "ws://YOUR_SERVER_IP:5000"
```

**Note**: Replace `YOUR_SERVER_IP` with your server's actual IP address (e.g., `192.168.1.79`)

To find your server's IP address:
- **Windows**: `ipconfig` in Command Prompt
- **Linux/Mac**: `ifconfig` or `ip addr` in Terminal

The server listens on port **8765** for thin client connections.

## Usage

### Running the System

#### Standalone Mode (Recommended - Full Performance)

**On Server PC:**
```bash
# Start the OpenGL-accelerated game server
python game_server_pyglet_complete.py
```

This launches a full-screen game with:
- **OpenGL rendering** via Pyglet for maximum performance
- **WebSocket server** on port 8765 for optional Pi camera input
- **Mouse control** for testing (blue cursor on screen)
- **Keyboard support** (ESC to exit)
- **Hand tracking** when Pi camera is connected

Expected performance:
- **Menu**: 120+ FPS
- **Monopoly**: 60+ FPS (with dedicated GPU)
- **Blackjack/D&D**: 60+ FPS

#### Method 2: With Raspberry Pi Camera (Optional)

**On Server PC:**
```bash
# Start the game server first
python game_server_pyglet_complete.py
```

**On Raspberry Pi:**
```bash
# Connect camera client
python pi_client.py
```

When connected:
- Pi sends camera feed to server
- Server processes hand tracking
- Fingertips control the game
- Mouse cursor changes to red when hands detected

### Game Controls

The game supports two input methods:

#### Hand Tracking (Primary Method)
1. **Point your index finger** at any button or interactive element
2. **Hold it steady** for ~1 second to activate
3. A **circular progress indicator** appears showing activation progress

#### Mouse Control (Testing/Fallback)
- **Move mouse** to position cursor
- **Hover over elements** for 1 second to activate
- Same circular progress indicator appears
- Works on both server and thin client

#### Keyboard
- **ESC**: Exit application immediately
- **Text input**: Supported in D&D character creation

### Available Games

#### Monopoly (COMPLETE IMPLEMENTATION)

**Player Selection**:
1. Hover over "Monopoly" button in main menu
2. Select 2-8 players by hovering over circular slots
3. Hover "Start" button (center) when ready

**Player Panels** (each player has 3 buttons):
- **Roll/End Turn**: Roll dice or end your turn
  - Shows "Roll" when doubles were rolled (you can roll again)
  - In jail: special buttons (Roll for doubles, Pay $50, Use Card)
- **Deeds**: View and manage all your properties
  - Mortgage/unmortgage properties (no houses allowed)
  - Navigate with ◄/► buttons
  - Shows property details and mortgage values
- **Trade**: Initiate trades with other players
  - Select trade partner
  - Add/remove money ($50-$500 increments)
  - Add/remove properties (mortgaged properties excluded)
  - Send proposal to partner for acceptance

**Core Gameplay**:
- **Current player** highlighted with gold border on panel
- **Roll dice** → Token animates smoothly to new position
- **Landing on properties**:
  - **Unowned**: Buy or Pass (Pass triggers auction)
  - **Owned by others**: Pay rent (amount shown)
  - **Owned by you + monopoly**: Build houses/hotels
- **Special spaces**:
  - **Go**: Collect $200
  - **Free Parking**: Collect accumulated pot (taxes/fines)
  - **Go to Jail**: Sent directly to jail (no $200)
  - **Just Visiting**: No penalty
  - **Income Tax**: Pay $200 (goes to Free Parking pot)
  - **Luxury Tax**: Pay $100 (goes to Free Parking pot)
  - **Chance/Community Chest**: Draw and execute card actions

**Advanced Features**:
- **Building Houses/Hotels**:
  - Must own all properties in color group (monopoly)
  - Build evenly (can't build 2 houses on one if others have 0)
  - Supply limits: 32 houses, 12 hotels in bank
  - 4 houses → 1 hotel (returns 4 houses to bank)
  - Sell back to bank for half price
  - Button shows "No Supply" when bank is out
- **Mortgaging**:
  - Mortgage for cash (shown value)
  - Unmortgage for 110% of mortgage value
  - Can't mortgage properties with houses
  - Mortgaged properties don't collect rent
- **Jail System**:
  - Get out by: Rolling doubles, Paying $50, Using card
  - Must pay after 3 failed rolls
  - Special panel buttons when in jail
- **Auctions** (when player declines to buy):
  - All players bid in turn
  - Minimum bid increases by $10
  - Pass or bid until one player remains
  - Winner pays bid amount
- **Trading**:
  - Trade money and/or properties
  - Both players must accept
  - Can't trade mortgaged or developed properties
  - Properties transfer ownership immediately
- **Bankruptcy**:
  - When you can't pay rent/taxes
  - Properties transfer to creditor (if player) or bank
  - Houses/hotels return to bank supply
  - Game continues until one player remains
- **Doubles**:
  - Roll again if you roll doubles
  - 3 doubles in a row → Go to Jail
  - Jail doubles don't count toward 3-in-a-row

**All Chance/Community Chest Cards Implemented**:
- Movement (advance to property, go back, nearest railroad/utility)
- Money (collect/pay various amounts)
- Repairs (pay per house/hotel)
- Get Out of Jail Free
- Go to Jail
- Collect from/pay other players
- Advance to Go (collect $200)

#### Blackjack (COMPLETE CASINO-STYLE IMPLEMENTATION)

**Player Selection**:
1. Hover over "Blackjack" button in main menu
2. Select 2-8 players by hovering over circular slots
3. Hover "Start" button when ready

**Betting Phase** (Simultaneous for all players):
- Each player starts with **$1000**
- **Bet buttons**: $5, $25, $100, $500 (additive - can combine amounts)
- **Ready button**: Confirms bet and locks in for round
- Players with $0 are automatically marked as "BROKE"
- Game waits for all players to ready up before dealing

**Card Dealing** (Animated):
- Cards animate from center deck to each player
- **0.5 seconds per card** with smooth movement
- Two cards dealt to each player, two to dealer
- Dealer's second card is face-down
- Cards appear immediately after animation completes

**Playing Phase**:
- All players act simultaneously (no turn order)
- Each player sees their own action buttons:
  - **Hit**: Draw another card (with animation)
  - **Stand**: Keep current hand
  - **Double Down**: Double bet, get one card, automatically stand
  - **Split**: Split matching cards into two hands (if applicable)
- Players count their own cards (no values displayed)
- **Bust indicator**: Red X appears through cards if over 21
- Cards are positioned and rotated for each player's perspective (Monopoly-style)

**Dealer's Turn** (Automatic):
- Reveals face-down card
- Draws cards with **animated dealing** until reaching 17+
- Follows standard casino rules: Hit on 16, Stand on 17
- Dealer bust shown if over 21

**Results Phase**:
- **WIN!**: Player's hand beats dealer (2:1 payout)
- **BLACKJACK!**: Natural 21 with first two cards (3:2 payout)
- **PUSH**: Tie with dealer (bet returned)
- **LOSE**: Dealer wins (bet lost)
- **BUST**: Player over 21 (bet lost)
- Results shown in each player's panel info
- 3-second delay to view results

**Game End Conditions**:
- **All players broke**: Game Over screen, return to menu after 5s
- **One player remains**: That player wins, game ends
- **Multiple players with chips**: New round starts automatically
- Game tracks all player balances throughout session

**Advanced Features**:
- **Player-colored card borders** (3px) for easy identification
- **Rotated panel text** showing balance, bet, and ready status
- **Smooth card animations** with ease-out deceleration
- **Proper blackjack payouts**: 3:2 for blackjack, 2:1 for regular wins
- **Auto-ready broke players**: Players with $0 automatically skip betting
- **Instant card visibility**: Cards appear as soon as animation completes
- **Simultaneous gameplay**: All players bet and play at the same time

#### Dungeons & Dragons
1. **Select game**: Hover over "D&D" button in main menu
2. **Character Creation** (full-screen immersive experience):
   - **Choose Race**: Human, Elf, Dwarf, Halfling, Orc, or Tiefling
   - **Choose Class**: Fighter, Wizard, Rogue, Cleric, Ranger, or Paladin
   - **Set Abilities**: Distribute 27 points across STR, DEX, CON, INT, WIS, CHA
   - Character names are automatically generated based on race/class
3. **Save/Load**: Characters are saved and can be loaded in future sessions
4. **DM Mode**: Right player (position 7) is always the Dungeon Master
5. **Gameplay**:
   - View character sheets
   - Roll d20 with automatic crit highlighting
   - Turn-based character actions

## Video Display

When the server runs with `python main.py server`, a video window automatically opens showing:

- **Live camera feed** from the Raspberry Pi
- **Colored circles** around detected fingertips
- **Hand labels** (Left/Right with hand ID)
- **Hand count** in the top-left corner

**Keyboard shortcuts** in video window:
- Press `Q` to close the video window
- Press `ESC` to exit the game

## Project Structure

```
ARPi2/
├── game_server_pyglet_complete.py  # MAIN: OpenGL game server (Pyglet)
├── config.py                       # Configuration (window size, FPS, colors)
├── constants.py                    # Game constants (cards, deck definitions)
├── monopoly_data.py               # Monopoly board data and property groups
├── pi_client.py                   # Optional: Raspberry Pi camera client
├── server.py                      # WebSocket server for camera input
├── pyglet_games/                  # OpenGL game implementations
│   ├── renderer.py               # Pyglet rendering engine (batched drawing)
│   ├── monopoly_rebuilt.py       # Complete Monopoly (2100+ lines)
│   ├── blackjack_complete.py     # Complete Blackjack (1500+ lines)
│   ├── dnd_complete.py           # D&D character creation
│   ├── player_selection.py       # Player selection UI
│   ├── ui_components_pyglet.py   # UI components (buttons, panels)
│   └── popup_system.py           # Universal popup system
├── monopoly/                      # Monopoly game logic modules
│   ├── game.py                   # Core game state management
│   ├── player.py                 # Player class
│   ├── property.py               # Property class with rent calculation
│   ├── game_logic.py             # Game rules and mechanics
│   ├── drawing.py                # Legacy Pygame drawing
│   └── popups.py                 # Legacy Pygame popups
└── Legacy files (Pygame versions, not actively used)
    ├── main.py
    ├── launcher.py
    ├── game_launcher.py
    └── ...
```

**Key Files**:
- `game_server_pyglet_complete.py`: Main entry point, run this
- `pyglet_games/monopoly_rebuilt.py`: Complete Monopoly with all features
- `monopoly_data.py`: All 40 board spaces, property data, rent arrays
- `constants.py`: All Chance and Community Chest cards

## Network Architecture

### Thin Client Mode (Recommended)

```
┌──────────────────────────┐
│   Raspberry Pi           │
│   (Thin Client)          │
│                          │
│  1. Camera Capture       │──── Camera Feed ────▶
│  2. Display Frames       │◀─── Game Frames ─────┐
│  3. Send Mouse/Keyboard  │──── Input Events ────▶│
│                          │                        │
│  pi_thin_client.py       │                        │
└──────────────────────────┘                        │
                                                    │
                                    ┌───────────────▼────────────┐
                                    │   Server PC                │
                                    │   (Does Everything)        │
                                    │                            │
                                    │  1. Hand Tracking          │
                                    │  2. Game Logic             │
                                    │  3. Rendering              │
                                    │  4. Frame Compression      │
                                    │                            │
                                    │  game_server_full.py       │
                                    └────────────────────────────┘
```

### Legacy Mode (Original)

```
┌─────────────────┐         ┌─────────────────┐
│  Raspberry Pi   │         │   Server PC     │
│  (Camera)       │──────▶│  (Processing)   │
│                 │ frames  │                 │
│  pi_client.py   │         │  server.py      │
└─────────────────┘         │  video_display  │
                            └────────┬────────┘
                                     │ hand data
                                     ▼
                            ┌─────────────────┐
                            │  Game Client    │
                            │  (UI)           │
                            │  launcher.py    │
                            └─────────────────┘
```

## Troubleshooting

### GPU Configuration (Windows Laptops with NVIDIA/AMD)

If you see "OpenGL Renderer: Intel(R) Iris(R) Xe Graphics" or low FPS:

**Windows 10/11 Graphics Settings** (Recommended):
1. Open Settings → System → Display → Graphics Settings
2. Click "Browse" and find your Python executable:
   - Run `where python` in Command Prompt to find path
   - Typically: `C:\Users\YourName\AppData\Local\Programs\Python\Python311\python.exe`
3. Click "Options" → Select "High performance"
4. Restart the application

**NVIDIA Control Panel** (Alternative):
1. Right-click desktop → NVIDIA Control Panel
2. Manage 3D Settings → Program Settings
3. Click "Add" → Browse to `python.exe`
4. Set preferred GPU to "High-performance NVIDIA processor"
5. Click "Apply" and restart application

**Verify GPU is active**:
- Console shows: "OpenGL Renderer: NVIDIA ..." or "AMD ..."
- Should NOT show "Intel" for integrated graphics
- FPS should be 60+ in Monopoly

### Performance Issues

**If FPS is low despite correct GPU**:
- Ensure VSync is disabled (default in code)
- Close other GPU-intensive applications
- Update graphics drivers
- Check Task Manager → Performance → GPU usage

**Expected Performance** (with dedicated GPU):
- Main menu: 120+ FPS
- Monopoly (no popup): 60+ FPS
- Monopoly (with popup): 60+ FPS
- Game is fully playable even at 30 FPS

### Camera not connecting
- Check IP address configuration in `config.py`
- Ensure both devices are on the same network
- Check firewall settings (port 8765 should be open)
- Test connection: `ping YOUR_SERVER_IP`

### Hand tracking not working
- Ensure good lighting conditions
- Keep hands within camera view
- Camera should have clear view of gesture area
- Check server console for "Hands tracked: X" messages
- Mouse cursor changes from blue to red when hands detected

### Game not responding to gestures/mouse
- Hold finger/mouse steady for full 1 second
- Watch for circular progress indicator
- Ensure you're pointing at clickable elements
- Press **ESC** to exit if stuck

### Application won't exit
- Press **ESC** key (immediate exit)
- Use **Ctrl+C** in terminal as backup
- Close window directly if needed

## Camera Setup

For optimal hand tracking:

1. **Position**: Mount camera overhead, angled down at ~45° toward the table
2. **Height**: 2-3 feet above the play surface
3. **Lighting**: Ensure even, bright lighting (avoid shadows)
4. **Background**: Use a plain, contrasting surface
5. **Coverage**: Camera should see the entire play area

## Development

### Adding New Games

1. Create a new game class similar to `MonopolyGame` in `monopoly.py`
2. Add game button in `launcher.py` (`_create_game_buttons`)
3. Handle game initialization in `launcher.py` (`handle_menu_state`)

### Customizing Hand Tracking

Edit `server.py`:
```python
hands_detector = mp_hands.Hands(
    max_num_hands=8,              # Maximum hands to detect
    min_detection_confidence=0.5,  # Lower = more sensitive
    min_tracking_confidence=0.5    # Lower = more tracking noise
)
```

### Adjusting Hover Time

Edit `HOVER_TIME_THRESHOLD` in:
- `launcher.py` (line 14)
- `ui_elements.py` (line 5)
- `ui_components.py` (line 4)

Default is 0.9 seconds. Lower values = faster activation.

## Performance

| Component | FPS | Notes |
|-----------|-----|-------|
| Main Menu | 120+ | Minimal rendering |
| Monopoly | 60+ | With dedicated GPU |
| Blackjack | 60+ | Card animations |
| D&D | 60+ | Character sheets |

**Graphics API**: OpenGL via Pyglet for hardware acceleration
**Rendering**: Batched drawing for optimal GPU usage
**VSync**: Disabled by default for maximum FPS

## Known Limitations

- Only index finger is tracked for interactions
- Maximum 8 players supported
- Network latency depends on WiFi quality (LAN cable recommended for Pi)
- Monopoly: **COMPLETE** - All features implemented (trading, auctions, mortgages, building, jail, bankruptcy)
- Blackjack: **COMPLETE** - Full casino-style implementation (simultaneous play, animations, proper payouts, game end detection)
- D&D features in development:
  - Full combat system
  - Inventory management
  - Quest/campaign tracking
  - NPC interactions

## License

[Add your license here]

## Contributing

[Add contribution guidelines here]

## Credits

- Hand tracking: MediaPipe by Google
- Graphics: Pyglet (OpenGL acceleration)
- Networking: Websockets
- Game design: Hasbro (Monopoly), Wizards of the Coast (D&D)